name: Build GStreamer Decoders (aarch64, Dev)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 7 * * *'
  pull_request:

permissions:
  contents: write
  packages: write

env:
  LAST_COMMIT_FILE: last_gst_commit.txt
  INSTALL_ROOT: /data/data/com.termux/files/usr/glibc

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
      # ğŸ§© æ£€å‡ºå½“å‰ä»“åº“
      - name: æ£€å‡º workflow ä»“åº“
        uses: actions/checkout@v4

      # ğŸ“¦ å®‰è£…ä¾èµ–
      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3-pip git pkg-config \
            libglib2.0-dev libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            liborc-0.4-dev libxv-dev libx11-dev libasound2-dev libpulse-dev patchelf \
            libtheora-dev libvpx-dev libx264-dev libx265-dev libdav1d-dev libgav1-dev
      # âš™ï¸ å‡çº§ Meson å’Œ Ninja
      - name: å‡çº§ Meson å’Œ Ninja
        run: |
          pip install --upgrade pip
          pip install --upgrade meson ninja
      # ğŸ§¬ å…‹éš† GStreamer å¼€å‘ç‰ˆæœ¬
      - name: å…‹éš† GStreamer å¼€å‘ç‰ˆæœ¬
        run: |
          git clone --depth=1 https://gitlab.freedesktop.org/gstreamer/gstreamer.git
      # ğŸ” è·å–å¼€å‘ç‰ˆæœ¬ä¿¡æ¯
      - name: è·å–å¼€å‘ç‰ˆæœ¬ä¿¡æ¯
        id: get_dev_info
        run: |
          cd gstreamer
          LATEST_COMMIT=$(git rev-parse HEAD)
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          AUTHOR=$(git log -1 --pretty=format:'%an')
          DATE=$(date -u '+%Y-%m-%d %H:%M UTC')
          COMMIT_DATE=$(git log -1 --pretty=format:'%cd' --date=short)
          
          VERSION=$(sed -n '2p' "meson.build" | grep -oP "version\s*:\s*'\K[^']+")
          
          echo "LATEST_COMMIT=$LATEST_COMMIT" >> $GITHUB_ENV
          echo "COMMIT_SHORT=$COMMIT_SHORT" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "AUTHOR=$AUTHOR" >> $GITHUB_ENV
          echo "BUILD_DATE=$DATE" >> $GITHUB_ENV
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV
          echo "ğŸ†• å¼€å‘ç‰ˆæœ¬: $VERSION"
          echo "ğŸ§¬ æœ€æ–°æäº¤: $LATEST_COMMIT"
          echo "ğŸ“… æäº¤æ—¥æœŸ: $COMMIT_DATE"
          echo "ğŸ‘¤ ä½œè€…: $AUTHOR"
          echo "ğŸ•“ æ„å»ºæ—¶é—´: $DATE"
      # ğŸ’¾ è·å–ä¸Šæ¬¡æ„å»ºæäº¤
      - name: è·å–ä¸Šæ¬¡æ„å»ºæäº¤
        id: get_last_commit
        run: |
          FILE=${{ env.LAST_COMMIT_FILE }}
          if [ -f "$FILE" ]; then
            LAST_COMMIT=$(cat "$FILE")
          else
            echo "none" > "$FILE"
            LAST_COMMIT="none"
          fi
          echo "LAST_COMMIT=$LAST_COMMIT" >> $GITHUB_ENV
          echo "ğŸ“¦ ä¸Šæ¬¡æ„å»ºæäº¤: $LAST_COMMIT"
      # ğŸ” åˆ¤æ–­æ˜¯å¦éœ€è¦æ„å»º
      - name: åˆ¤æ–­æ˜¯å¦éœ€è¦æ„å»º
        id: check_build
        run: |
          if [ "$LATEST_COMMIT" = "$LAST_COMMIT" ]; then
            echo "skip_build=true" >> $GITHUB_OUTPUT
            echo "ğŸŸ¡ æäº¤æœªæ›´æ–°ï¼Œè·³è¿‡æ„å»ºã€‚"
          else
            echo "skip_build=false" >> $GITHUB_OUTPUT
            echo "âœ… å‘ç°æ–°æäº¤: $LATEST_COMMIT"
          fi
      # â­ï¸ è·³è¿‡æ— æ›´æ–°æ„å»º
      - name: è·³è¿‡æ— æ›´æ–°æ„å»º
        if: steps.check_build.outputs.skip_build == 'true'
        run: exit 0

      # ğŸ› ï¸ æ„å»º GStreamer è§£ç å™¨ï¼ˆå¼€å‘ç‰ˆæœ¬ï¼‰
      - name: æ„å»º GStreamer è§£ç å™¨
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          cd gstreamer
          echo "ğŸ”„ æ›´æ–°å­æ¨¡å—..."
          git submodule update --init --recursive
          
          sudo mkdir -p $INSTALL_ROOT
          sudo chmod -R 777 /data
          
          echo "âš™ï¸ é…ç½®æ„å»ºç³»ç»Ÿ..."
          meson setup build \
            --prefix=$INSTALL_ROOT \
            --libdir=lib \
            -Dlibexecdir=lib/gstreamer1.0 \
            -Dbase=enabled -Dgood=enabled -Dugly=enabled -Dbad=enabled \
            -Dlibav=enabled -Dgpl=disabled -Ddefault_library=shared \
            -Dtests=disabled -Ddoc=disabled -Dexamples=disabled \
            -Dpython=disabled -Dgst-plugins-good:vpx=enabled -Dgst-plugins-bad:hip=disabled -Dgst-plugins-bad:nvcodec=disabled -Dgst-plugins-base:gl=disabled -Dintrospection=disabled \
            -Dgst-full=enabled -Dgst-full-plugins='*' \
            -Ddevtools=enabled -Drtsp_server=disabled \
            --buildtype=release
          
          echo "ğŸ—ï¸ ç¼–è¯‘ä¸­..."
          ninja -C build -j$(nproc)
          
          echo "ğŸ“¦ å®‰è£…ä¸­..."
          ninja -C build install
          
          echo "âœ… GStreamer å¼€å‘ç‰ˆæœ¬æ„å»ºå®Œæˆ"
      # ğŸ§© ä¿®è¡¥ ELF è§£é‡Šå™¨
      - name: ä¿®è¡¥ ELF å¯æ‰§è¡Œæ–‡ä»¶
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          INTERP=$INSTALL_ROOT/lib/ld-linux-aarch64.so.1
          echo "ğŸ”§ ä¿®è¡¥ ELF è§£é‡Šå™¨: $INTERP"
          
          # ä¿®è¡¥äºŒè¿›åˆ¶æ–‡ä»¶
          if [ -d "$INSTALL_ROOT/bin" ]; then
            echo "ğŸ“ ä¿®è¡¥ bin ç›®å½•..."
            find "$INSTALL_ROOT/bin" -type f -exec file {} \; | grep 'ELF' | cut -d: -f1 | while read f; do
              patchelf --set-interpreter "$INTERP" "$f" 2>/dev/null || true
            done
          fi
          
          # ä¿®è¡¥åº“æ–‡ä»¶
          if [ -d "$INSTALL_ROOT/lib" ]; then
            echo "ğŸ“ ä¿®è¡¥ lib ç›®å½•..."
            find "$INSTALL_ROOT/lib" -name "*.so*" -type f -exec file {} \; | grep 'ELF' | cut -d: -f1 | while read f; do
              patchelf --set-interpreter "$INTERP" "$f" 2>/dev/null || true
            done
          fi
          
          # ä¿®è¡¥ GStreamer æ’ä»¶
          if [ -d "$INSTALL_ROOT/lib/gstreamer1.0" ]; then
            echo "ğŸ“ ä¿®è¡¥ GStreamer æ’ä»¶ç›®å½•..."
            find "$INSTALL_ROOT/lib/gstreamer1.0" -name "*.so" -type f -exec file {} \; | grep 'ELF' | cut -d: -f1 | while read f; do
              patchelf --set-interpreter "$INTERP" "$f" 2>/dev/null || true
            done
          fi
      # ğŸ§± æ‰“åŒ…æ„å»ºç»“æœ
      - name: æ‰“åŒ… glibc ç›®å½•
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          cd /data/data/com.termux/files/usr
          TAR_NAME="termux-glibc-gst-decoders-${VERSION}.tar.gz"
          echo "ğŸ“¦ æ‰“åŒ…: $TAR_NAME"
          tar -czvf /home/runner/$TAR_NAME glibc
          echo "TAR_NAME=$TAR_NAME" >> $GITHUB_ENV
          
          # ä¿å­˜å½“å‰æäº¤è®°å½•
          echo "$LATEST_COMMIT" > ${{ env.LAST_COMMIT_FILE }}
          echo "âœ… æ‰“åŒ…å®Œæˆ: $TAR_NAME"
      # â¬†ï¸ ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        if: steps.check_build.outputs.skip_build == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TAR_NAME }}
          path: /home/runner/${{ env.TAR_NAME }}

      # ğŸ’¾ ä¸Šä¼ æäº¤è®°å½•
      - name: ä¸Šä¼ æäº¤è®°å½•
        if: steps.check_build.outputs.skip_build == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: last-gst-commit
          path: ${{ env.LAST_COMMIT_FILE }}
          retention-days: 365

      # ğŸš€ å‘å¸ƒåˆ° GitHub Release
      - name: å‘å¸ƒåˆ° GitHub Release
        if: steps.check_build.outputs.skip_build == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION }}
          name: "GStreamer Decoders ${{ env.VERSION }} (aarch64, Termux glibc)"
          body: |
            ## ğŸ¯ GStreamer å¼€å‘ç‰ˆæœ¬æ„å»º
            
            ### ğŸ“‹ æ„å»ºä¿¡æ¯
            - **ç‰ˆæœ¬**: `${{ env.VERSION }}`
            - **æ¶æ„**: aarch64
            - **ç¯å¢ƒ**: Termux glibc
            - **æäº¤**: [`${{ env.COMMIT_SHORT }}`](https://gitlab.freedesktop.org/gstreamer/gstreamer/-/commit/${{ env.LATEST_COMMIT }})
            - **æäº¤æ—¥æœŸ**: ${{ env.COMMIT_DATE }}
            - **ä½œè€…**: `${{ env.AUTHOR }}`
            - **æ„å»ºæ—¶é—´**: `${{ env.BUILD_DATE }}`
            
            ### ğŸ› ï¸ æ„å»ºç‰¹æ€§
            - âœ… **åŸºç¡€æ’ä»¶** (base)
            - âœ… **ä¼˜è´¨æ’ä»¶** (good) 
            - âœ… **ä¸‘é™‹æ’ä»¶** (ugly)
            - âœ… **ä¸è‰¯æ’ä»¶** (bad)
            - âœ… **LibAV æ”¯æŒ**
            - âœ… **GPL æ’ä»¶**
            - âœ… **å¼€å‘å·¥å…·**
            - âŒ **RTSP æœåŠ¡å™¨** (å·²ç¦ç”¨)
            - ğŸ—ï¸ **æ„å»ºç±»å‹**: release
            
            ### ğŸ“¦ æ–‡ä»¶ä¿¡æ¯
            - **æ–‡ä»¶å**: `${{ env.TAR_NAME }}`
            - **åŒ…å«**: å®Œæ•´çš„ GStreamer å¼€å‘ç‰ˆæœ¬å®‰è£…
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            - æ­¤ä¸ºå¼€å‘ç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªç¨³å®šçš„ç‰¹æ€§
            - å»ºè®®ä»…ç”¨äºæµ‹è¯•å’Œå¼€å‘ç›®çš„
            - ç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨ç¨³å®šç‰ˆæœ¬
            
            ### ğŸ“¥ ä½¿ç”¨æ–¹æ³•
            1. ä¸‹è½½å¹¶è§£å‹åˆ° Termux çš„ `/data/data/com.termux/files/usr/` ç›®å½•
            2. è®¾ç½®ç¯å¢ƒå˜é‡: `export GST_PLUGIN_PATH=/data/data/com.termux/files/usr/glibc/lib/gstreamer1.0`
            3. æµ‹è¯•: `gst-inspect-1.0 --version`
          files: /home/runner/${{ env.TAR_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
