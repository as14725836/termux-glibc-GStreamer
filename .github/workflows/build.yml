name: Build GStreamer Decoders (aarch64)

on:
  workflow_dispatch:
  pull_request:

permissions:
  contents: write  # å…è®¸ GITHUB_TOKEN åˆ›å»º Release

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
    - name: æ£€å‡ºæºç 
      uses: actions/checkout@v4

    - name: å®‰è£…åŸºç¡€ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential python3-pip git \
          pkg-config libglib2.0-dev libgstreamer1.0-dev \
          libgstreamer-plugins-base1.0-dev \
          liborc-0.4-dev libxv-dev libx11-dev \
          libasound2-dev libpulse-dev

    - name: å‡çº§ Meson å’Œ Ninja åˆ°æœ€æ–°ç‰ˆæœ¬
      run: |
        pip install --upgrade pip
        pip install --upgrade meson ninja
        meson --version
        ninja --version

    - name: å…‹éš† GStreamer æºç 
      run: |
        git clone https://gitlab.freedesktop.org/gstreamer/gstreamer.git
        cd gstreamer
        git submodule update --init --recursive

    - name: æå– GStreamer ç‰ˆæœ¬å·
      id: version
      run: |
        cd gstreamer
        VERSION=$(grep -Po "(?<=version: ')[^']+" meson.build)
        echo "Detected version: $VERSION"
        echo "VERSION=$VERSION" >> $GITHUB_ENV

    - name: æ„å»º GStreamer è§£ç å™¨
      run: |
        cd gstreamer
        sudo mkdir -p /data/data/com.termux/files/usr/glibc
        sudo chmod 777 -R /data

        meson setup build \
          --libdir=lib \
          --prefix=/data/data/com.termux/files/usr/glibc \
          -Dbase=enabled \
          -Dgood=enabled \
          -Dugly=enabled \
          -Dbad=enabled \
          -Dlibav=enabled \
          -Dgpl=enabled \
          -Dtests=disabled \
          -Dexamples=disabled \
          -Dpython=disabled \
          -Dintrospection=disabled \
          -Dgst-full=enabled \
          -Dgst-full-plugins='*' \
          --buildtype=release

        ninja -C build -j$(nproc)
        ninja -C build install

    - name: æ‰“åŒ… glibc æ–‡ä»¶å¤¹ (é™„å¸¦ç‰ˆæœ¬å·)
      run: |
        cd /data/data/com.termux/files/usr
        TAR_NAME="termux-glibc-gst-decoders-${VERSION}.tar.gz"
        tar -czvf ~/${TAR_NAME} glibc
        echo "TAR_NAME=${TAR_NAME}" >> $GITHUB_ENV

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.TAR_NAME }}
        path: ~/$(echo ${{ env.TAR_NAME }})

    - name: å‘å¸ƒåˆ° GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ env.VERSION }}
        name: GStreamer Decoders v${{ env.VERSION }} (aarch64, Termux glibc)
        files: ~/$(echo ${{ env.TAR_NAME }})
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: è¾“å‡ºå®Œæˆä¿¡æ¯
      run: |
        echo "âœ… GStreamer è§£ç å™¨æ„å»ºå®Œæˆ"
        echo "ğŸ“¦ è¾“å‡ºæ–‡ä»¶: $TAR_NAME"
        echo "ğŸ”– ç‰ˆæœ¬å·: $VERSION"
