name: Build GStreamer Decoders (aarch64, Dev)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 7 * * *'  # æ¯å¤©æ—©ä¸Š7ç‚¹è‡ªåŠ¨æ„å»ºæ£€æŸ¥æ›´æ–°
  pull_request:

permissions:
  contents: write  # å…è®¸ GITHUB_TOKEN åˆ›å»º Release

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
      # ğŸ§© æ£€å‡ºæºç 
      - name: æ£€å‡ºæºç 
        uses: actions/checkout@v4

      # ğŸ“¦ å®‰è£…åŸºç¡€ä¾èµ–
      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential python3-pip git \
            pkg-config libglib2.0-dev libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            liborc-0.4-dev libxv-dev libx11-dev \
            libasound2-dev libpulse-dev patchelf \
            libtheora-dev libvpx-dev libx264-dev libx265-dev \
            libdav1d-dev libgav1-dev

      # âš™ï¸ å‡çº§ Meson å’Œ Ninja
      - name: å‡çº§ Meson å’Œ Ninja åˆ°æœ€æ–°ç‰ˆæœ¬
        run: |
          pip install --upgrade pip
          pip install --upgrade meson ninja
          meson --version
          ninja --version

      # ğŸ§¬ å…‹éš† GStreamer æºç å¹¶è®°å½•æœ€æ–°æäº¤
      - name: å…‹éš† GStreamer æºç ï¼ˆå¼€å‘åˆ†æ”¯ï¼‰
        id: get_latest
        run: |
          git clone https://gitlab.freedesktop.org/gstreamer/gstreamer.git
          cd gstreamer
          git checkout main
          git pull origin main
          git submodule update --init --recursive
          echo "LATEST_COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV

      # ğŸ’¾ æ™ºèƒ½æ£€æµ‹ + ä¸‹è½½ä¸Šæ¬¡æ„å»ºæäº¤è®°å½•
      - name: æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸Šæ¬¡æ„å»ºæäº¤è®°å½•
        id: check_artifact
        run: |
          echo "ğŸ” æ­£åœ¨æ£€æµ‹æ˜¯å¦å­˜åœ¨ä¸Šæ¬¡æ„å»ºçš„æäº¤è®°å½•..."
          ARTIFACT_API="https://api.github.com/repos/${{ github.repository }}/actions/artifacts"
          RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$ARTIFACT_API")
          if echo "$RESPONSE" | grep -q '"name": "last-gst-decoders-commit"'; then
            echo "artifact_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°ä¸Šæ¬¡æ„å»ºçš„æäº¤è®°å½• artifactã€‚"
          else
            echo "artifact_exists=false" >> $GITHUB_OUTPUT
            echo "âšª æœªæ£€æµ‹åˆ°ä¸Šæ¬¡æ„å»ºè®°å½•ï¼ˆå¯èƒ½æ˜¯é¦–æ¬¡è¿è¡Œï¼‰ã€‚"
          fi

      # â¬‡ï¸ ä¸‹è½½ä¸Šæ¬¡æ„å»ºæäº¤è®°å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      - name: ä¸‹è½½ä¸Šæ¬¡æ„å»ºæäº¤è®°å½•
        if: steps.check_artifact.outputs.artifact_exists == 'true'
        uses: actions/download-artifact@v4
        with:
          name: last-gst-decoders-commit
          path: ./last_commit

      # âšª å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºç©ºç›®å½•é¿å…åç»­æŠ¥é”™
      - name: åˆ›å»ºç©º last_commit ç›®å½•
        if: steps.check_artifact.outputs.artifact_exists == 'false'
        run: |
          mkdir -p ./last_commit
          echo "none" > ./last_commit/last_gst_commit.txt

      # ğŸ” æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»º
      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»º
        id: check_build
        run: |
          LAST_COMMIT_FILE="./last_commit/last_gst_commit.txt"
          if [ -f "$LAST_COMMIT_FILE" ]; then
            LAST_COMMIT=$(cat "$LAST_COMMIT_FILE")
          else
            LAST_COMMIT="none"
          fi

          echo "ä¸Šæ¬¡æ„å»º commit: $LAST_COMMIT"
          echo "æœ€æ–°æºç  commit: $LATEST_COMMIT"

          if [ "$LATEST_COMMIT" = "$LAST_COMMIT" ]; then
            echo "skip_build=true" >> $GITHUB_OUTPUT
          else
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi

      # â­ï¸ è·³è¿‡æ— æ›´æ–°æ„å»º
      - name: è·³è¿‡æ— æ›´æ–°æ„å»º
        if: steps.check_build.outputs.skip_build == 'true'
        run: |
          echo "ğŸŸ¡ æ— æ–°æäº¤ï¼Œè·³è¿‡æ„å»ºã€‚"
          exit 0

      # ğŸ› ï¸ æ„å»º GStreamer è§£ç å™¨
      - name: æ„å»º GStreamer è§£ç å™¨
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          cd gstreamer
          sudo mkdir -p /data/data/com.termux/files/usr/glibc
          sudo chmod -R 777 /data
          echo "âš™ï¸ Meson setup å¼€å§‹..."
          meson setup build \
            --prefix=/data/data/com.termux/files/usr/glibc \
            --libdir=lib \
            -Dlibexecdir=lib/gstreamer1.0 \
            -Dbase=enabled \
            -Dgood=enabled \
            -Dugly=enabled \
            -Dbad=enabled \
            -Dlibav=enabled \
            -Dgpl=enabled \
            -Ddefault_library=shared \
            -Dtests=disabled \
            -Ddoc=disabled \
            -Dexamples=disabled \
            -Dpython=disabled \
            -Dintrospection=disabled \
            -Dgst-full=enabled \
            -Dgst-full-plugins='*' \
            --buildtype=release
          echo "ğŸ—ï¸ å¼€å§‹ç¼–è¯‘..."
          ninja -C build -j$(nproc)
          echo "ğŸ“¦ å®‰è£…åˆ° glibc ç›®å½•..."
          ninja -C build install

      # ğŸ§© ä¿®è¡¥ ELF
      - name: ä¿®è¡¥ ELF å¯æ‰§è¡Œæ–‡ä»¶
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          INTERP=/data/data/com.termux/files/usr/glibc/lib/ld-linux-aarch64.so.1
          ROOT=/data/data/com.termux/files/usr/glibc
          for dir in "$ROOT/bin" "$ROOT/lib/gstreamer1.0/gstreamer-1.0"; do
            if [ -d "$dir" ]; then
              echo "ğŸ”§ ä¿®è¡¥ç›®å½•: $dir"
              for f in "$dir"/*; do
                if file "$f" | grep -q 'ELF'; then
                  patchelf --set-interpreter "$INTERP" "$f" || true
                fi
              done
            fi
          done

      # ğŸ§± æ‰“åŒ…æ„å»ºç»“æœ
      - name: æ‰“åŒ… glibc ç›®å½•
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          cd /data/data/com.termux/files/usr
          TAR_NAME="termux-glibc-gst-decoders-${LATEST_COMMIT:0:7}.tar.gz"
          tar -czvf /home/runner/${TAR_NAME} glibc
          echo "TAR_NAME=${TAR_NAME}" >> $GITHUB_ENV
          echo "$LATEST_COMMIT" > last_gst_commit.txt

      # â¬†ï¸ ä¸Šä¼ äº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        if: steps.check_build.outputs.skip_build == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TAR_NAME }}
          path: /home/runner/${{ env.TAR_NAME }}

      # ğŸ’¾ ä¿å­˜ last commit
      - name: ä¸Šä¼  last commit è®°å½•
        if: steps.check_build.outputs.skip_build == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: last-gst-decoders-commit
          path: last_gst_commit.txt
          retention-days: 365

      # ğŸš€ å‘å¸ƒåˆ° Release
      - name: å‘å¸ƒåˆ° GitHub Release
        if: steps.check_build.outputs.skip_build == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAR_NAME }}
          name: "GStreamer Decoders ${{ env.TAR_NAME }} (aarch64, Termux glibc)"
          body: |
            âœ… è‡ªåŠ¨æ„å»ºæˆåŠŸï¼

            ğŸ”– Commit: [${{ env.LATEST_COMMIT }}](https://gitlab.freedesktop.org/gstreamer/gstreamer/-/commit/${{ env.LATEST_COMMIT }})
            ğŸ“¦ æ–‡ä»¶å: `${{ env.TAR_NAME }}`
          files: /home/runner/${{ env.TAR_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ’¬ åé¦ˆç»“æœ
      - name: å‘å¸ƒæ„å»ºä¿¡æ¯ï¼ˆPR/Commitï¼‰
        if: steps.check_build.outputs.skip_build == 'false'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          issue-number: ${{ github.event.pull_request.number || github.run_number }}
          body: |
            âœ… **GStreamer Decoders æ„å»ºå®Œæˆ**
            ğŸ”– Commit: `${{ env.LATEST_COMMIT }}`
            ğŸ“¦ æ–‡ä»¶: `${{ env.TAR_NAME }}`
