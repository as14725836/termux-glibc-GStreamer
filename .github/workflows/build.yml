name: Build GStreamer Decoders (aarch64, Dev)

on:
  workflow_dispatch:           # æ‰‹åŠ¨è§¦å‘
  schedule:                    # æ¯æ—¥è‡ªåŠ¨è§¦å‘
    - cron: '0 3 * * *'       # æ¯å¤© UTC æ—¶é—´ 03:00
  push:
    branches:
      - main                  # ä¸»åˆ†æ”¯æœ‰æ–°æäº¤æ—¶è§¦å‘
  pull_request:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
      - name: æ£€å‡ºæºç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0       # è·å–å®Œæ•´å†å²

      - name: è·å–æœ€æ–°æäº¤ hash
        id: get_hash
        run: |
          cd gstreamer || git clone https://gitlab.freedesktop.org/gstreamer/gstreamer.git gstreamer
          cd gstreamer
          git fetch origin main
          git checkout main
          git pull origin main
          git submodule update --init --recursive
          DEV_HASH=$(git rev-parse --short HEAD)
          echo "DEV_HASH=$DEV_HASH" >> $GITHUB_ENV
          echo "æœ€æ–°æäº¤ hash: $DEV_HASH"

      - name: æ£€æŸ¥æ˜¯å¦å·²æ„å»ºè¿‡æ­¤ç‰ˆæœ¬
        id: check_build
        run: |
          LAST_FILE="/home/runner/last_build_hash.txt"
          if [ -f "$LAST_FILE" ] && grep -q "${DEV_HASH}" "$LAST_FILE"; then
            echo "ç‰ˆæœ¬ $DEV_HASH å·²æ„å»ºè¿‡ï¼Œè·³è¿‡æ„å»ºã€‚"
            echo "SKIP_BUILD=true" >> $GITHUB_ENV
          else
            echo "SKIP_BUILD=false" >> $GITHUB_ENV
          fi

      - name: å®‰è£…åŸºç¡€ä¾èµ–
        if: env.SKIP_BUILD == 'false'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential python3-pip git \
            pkg-config libglib2.0-dev libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            liborc-0.4-dev libxv-dev libx11-dev \
            libasound2-dev libpulse-dev patchelf \
            libtheora-dev libvpx-dev libx264-dev libx265-dev \
            libdav1d-dev libgav1-dev \
            libavcodec-dev libavformat-dev libavutil-dev libswresample-dev \
            libavfilter-dev libavdevice-dev

      - name: å‡çº§ Meson å’Œ Ninja
        if: env.SKIP_BUILD == 'false'
        run: |
          pip install --upgrade pip
          pip install --upgrade meson ninja

      - name: æ„å»º GStreamer å¼€å‘è§£ç å™¨
        if: env.SKIP_BUILD == 'false'
        run: |
          cd gstreamer
          sudo mkdir -p /data/data/com.termux/files/usr/glibc
          sudo chmod -R 777 /data
          VERSION="dev-${DEV_HASH}"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          meson setup build \
            --prefix=/data/data/com.termux/files/usr/glibc \
            --libdir=lib \
            -Dlibexecdir=lib/gstreamer1.0 \
            -Dbase=enabled \
            -Dgood=enabled \
            -Dugly=enabled \
            -Dbad=enabled \
            -Dlibav=enabled \
            -Dgpl=enabled \
            -Ddefault_library=shared \
            -Dtests=disabled \
            -Ddoc=disabled \
            -Dexamples=disabled \
            -Dpython=disabled \
            -Dintrospection=disabled \
            -Dgst-full=enabled \
            -Dgst-full-plugins='*' \
            --buildtype=release
          ninja -C build -j$(nproc)
          ninja -C build install

      - name: å¯¹ ELF å¯æ‰§è¡Œæ–‡ä»¶åº”ç”¨ patchelf
        if: env.SKIP_BUILD == 'false'
        run: |
          INTERP=/data/data/com.termux/files/usr/glibc/lib/ld-linux-aarch64.so.1
          ROOT=/data/data/com.termux/files/usr/glibc
          for dir in bin lib/gstreamer1.0/gstreamer-1.0; do
            if [ -d "$ROOT/$dir" ]; then
              for f in "$ROOT/$dir/"*; do
                if file "$f" | grep -q 'ELF'; then
                  patchelf --set-interpreter "$INTERP" "$f" || true
                fi
              done
            fi
          done

      - name: æ‰“åŒ… glibc æ–‡ä»¶å¤¹
        if: env.SKIP_BUILD == 'false'
        run: |
          cd /data/data/com.termux/files/usr
          TAR_NAME="termux-glibc-gst-decoders-${DEV_HASH}.tar.gz"
          tar -czvf /home/runner/${TAR_NAME} glibc
          echo "TAR_NAME=${TAR_NAME}" >> $GITHUB_ENV
          echo "${DEV_HASH}" > /home/runner/last_build_hash.txt

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        if: env.SKIP_BUILD == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TAR_NAME }}
          path: /home/runner/${{ env.TAR_NAME }}

      - name: å‘å¸ƒåˆ° GitHub Release
        if: env.SKIP_BUILD == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION }}
          name: GStreamer Decoders ${{ env.VERSION }} (aarch64, Termux glibc)
          files: /home/runner/${{ env.TAR_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è¾“å‡ºå®Œæˆä¿¡æ¯
        run: |
          if [ "${SKIP_BUILD}" = "true" ]; then
            echo "âš ï¸ æ„å»ºå·²è·³è¿‡ï¼Œç‰ˆæœ¬ $DEV_HASH å·²å­˜åœ¨"
          else
            echo "âœ… GStreamer å¼€å‘è§£ç å™¨æ„å»ºå®Œæˆ"
            echo "ğŸ“¦ è¾“å‡ºæ–‡ä»¶: ${{ env.TAR_NAME }}"
            echo "ğŸ”– ç‰ˆæœ¬å·: ${{ env.VERSION }}"
