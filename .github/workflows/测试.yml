name: termux glibc ffmpeg

on:
  workflow_dispatch:
  schedule:
    - cron: '0 7 * * *'
  pull_request:

permissions:
  contents: write
  packages: write

env:
  LAST_COMMIT_FILE: last_ffmpeg_commit.txt
  INSTALL_ROOT: /data/data/com.termux/files/usr/glibc

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
      # ğŸ§© æ£€å‡º workflow ä»“åº“
      - name: æ£€å‡º workflow ä»“åº“
        uses: actions/checkout@v4

      # ğŸ“¦ å®‰è£…åŸºç¡€ä¾èµ–
      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3-pip git pkg-config nasm \
            libglib2.0-dev yasm libx264-dev libx265-dev libvpx-dev libmp3lame-dev \
            libopus-dev libtheora-dev libvorbis-dev libass-dev libfreetype6-dev \
            libfribidi-dev libgnutls28-dev libxvidcore-dev libxext-dev libxfixes-dev \
            libxcb1-dev libdrm-dev libva-dev libvdpau-dev libxcb-shm0-dev libxcb-xfixes0-dev \
            libnuma-dev libvulkan-dev libgl1-mesa-dev libglu1-mesa-dev patchelf

      # ğŸ“¦ å®‰è£…æˆ–æ„å»º libaom (éœ€è¦ >= 2.0.0)
      - name: å®‰è£… libaom >= 2.0.0
        run: |
          # å…‹éš†å¹¶æ„å»ºæœ€æ–°ç‰ˆæœ¬çš„ aom
          cd /tmp
          git clone --depth=1 https://aomedia.googlesource.com/aom
          cd aom
          mkdir build && cd build
          cmake -DCMAKE_INSTALL_PREFIX=/usr/local -DBUILD_SHARED_LIBS=1 -DENABLE_TESTS=0 -DENABLE_DOCS=0 -DENABLE_examples=0 ..
          make -j$(nproc)
          sudo make install
          sudo ldconfig
          
      # ğŸ§¬ å…‹éš† FFmpeg å¼€å‘ç‰ˆæœ¬
      - name: å…‹éš† FFmpeg å¼€å‘ç‰ˆæœ¬
        run: |
          git clone --depth=1 https://git.ffmpeg.org/ffmpeg.git

      # ğŸ” è·å–å¼€å‘ç‰ˆæœ¬ä¿¡æ¯
      - name: è·å–å¼€å‘ç‰ˆæœ¬ä¿¡æ¯
        id: get_dev_info
        run: |
          cd ffmpeg
          LATEST_COMMIT=$(git rev-parse HEAD)
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          AUTHOR=$(git log -1 --pretty=format:'%an')
          DATE=$(date -u '+%Y-%m-%d %H:%M UTC')
          COMMIT_DATE=$(git log -1 --pretty=format:'%cd' --date=short)
          VERSION=$(grep -m 1 -oP "(?<=define\\s+LIBAVUTIL_VERSION\\s+av_version\\(v)\\d+\\.\\d+\\.\\d+" libavutil/version.h | head -1)
          if [ -z "$VERSION" ]; then
            VERSION="n$(git rev-parse --short HEAD)"
          fi
          echo "LATEST_COMMIT=$LATEST_COMMIT" >> $GITHUB_ENV
          echo "COMMIT_SHORT=$COMMIT_SHORT" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "AUTHOR=$AUTHOR" >> $GITHUB_ENV
          echo "BUILD_DATE=$DATE" >> $GITHUB_ENV
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV

      # ğŸ’¾ è·å–ä¸Šæ¬¡æ„å»ºæäº¤
      - name: è·å–ä¸Šæ¬¡æ„å»ºæäº¤
        id: get_last_commit
        run: |
          FILE=${{ env.LAST_COMMIT_FILE }}
          if [ -f "$FILE" ]; then
            LAST_COMMIT=$(cat "$FILE")
          else
            echo "none" > "$FILE"
            LAST_COMMIT="none"
          fi
          echo "LAST_COMMIT=$LAST_COMMIT" >> $GITHUB_ENV

      # ğŸ” åˆ¤æ–­æ˜¯å¦éœ€è¦æ„å»º
      - name: åˆ¤æ–­æ˜¯å¦éœ€è¦æ„å»º
        id: check_build
        run: |
          if [ "$LATEST_COMMIT" = "$LAST_COMMIT" ]; then
            echo "skip_build=true" >> $GITHUB_OUTPUT
            echo "ğŸŸ¡ æäº¤æœªæ›´æ–°ï¼Œè·³è¿‡æ„å»ºã€‚"
          else
            echo "skip_build=false" >> $GITHUB_OUTPUT
            echo "âœ… å‘ç°æ–°æäº¤: $LATEST_COMMIT"
          fi

      # â­ï¸ è·³è¿‡æ— æ›´æ–°æ„å»º
      - name: è·³è¿‡æ— æ›´æ–°æ„å»º
        if: steps.check_build.outputs.skip_build == 'true'
        run: exit 0
      
      # ğŸ› ï¸ æ„å»º FFmpeg è§£ç å™¨
      - name: æ„å»º FFmpeg è§£ç å™¨
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          cd ffmpeg
          sudo mkdir -p $INSTALL_ROOT
          sudo chmod -R 777 /data
          
          # æ£€å‡ºç‰¹å®šç‰ˆæœ¬ä»¥ç¡®ä¿åº“ç‰ˆæœ¬å…¼å®¹æ€§
          # æŸ¥æ‰¾å¯ç”¨çš„ç‰ˆæœ¬åˆ†æ”¯
          git fetch --all
          
          # æ£€æŸ¥å¯ç”¨çš„è¿œç¨‹åˆ†æ”¯
          echo "å¯ç”¨çš„FFmpegåˆ†æ”¯:"
          git branch -r | grep -E "release|n5\.1|n4\.4|n6\.0" || echo "æœªæ‰¾åˆ°é¢„å®šä¹‰ç‰ˆæœ¬åˆ†æ”¯"
          
          # é¦–å…ˆå°è¯•æ„å»ºFFmpeg n6.0æˆ–n5.1ç‰ˆæœ¬ä»¥ç”Ÿæˆlibavformat.so.60/62, libavcodec.so.60/62, libavutil.so.58/60
          if git checkout n6.0 2>/dev/null || git checkout n5.1 2>/dev/null || git checkout release/5.1 2>/dev/null; then
            echo "æ­£åœ¨æ„å»ºFFmpeg 5.xä»¥ç”Ÿæˆç‰ˆæœ¬60/62åº“..."
            make clean 2>/dev/null || true
            rm -rf build 2>/dev/null || true
            ./configure \
              --prefix=$INSTALL_ROOT \
              --enable-shared \
              --enable-gpl \
              --enable-nonfree \
              --enable-libx264 \
              --enable-libx265 \
              --enable-libvpx \
              --enable-libmp3lame \
              --enable-libopus \
              --enable-libtheora \
              --enable-libvorbis \
              --enable-libass \
              --enable-libfreetype \
              --enable-libfribidi \
              --enable-libxvid \
              --enable-libaom \
              --enable-libdav1d \
              --disable-debug \
              --disable-doc \
              --enable-optimizations \
              --enable-pic \
              --enable-version3
            make -j$(nproc)
            sudo make install
          else
            echo "FFmpeg 5.1/6.0 release tag not found, using master"
            git checkout master
            ./configure \
              --prefix=$INSTALL_ROOT \
              --enable-shared \
              --enable-gpl \
              --enable-nonfree \
              --enable-libx264 \
              --enable-libx265 \
              --enable-libvpx \
              --enable-libmp3lame \
              --enable-libopus \
              --enable-libtheora \
              --enable-libvorbis \
              --enable-libass \
              --enable-libfreetype \
              --enable-libfribidi \
              --enable-libxvid \
              --enable-libaom \
              --enable-libdav1d \
              --disable-debug \
              --disable-doc \
              --enable-optimizations \
              --enable-pic \
              --enable-version3
            make -j$(nproc)
            sudo make install
          fi
          
          # æ£€å‡ºFFmpeg 4.4ä»¥ç”Ÿæˆç‰ˆæœ¬60åº“
          if git checkout n4.4 2>/dev/null || git checkout release/4.4 2>/dev/null; then
            echo "æ­£åœ¨æ„å»ºFFmpeg 4.4ä»¥ç”Ÿæˆç‰ˆæœ¬60åº“..."
            make clean 2>/dev/null || true
            rm -rf build_temp 2>/dev/null || true
            ./configure \
              --prefix=$INSTALL_ROOT/temp_44 \
              --enable-shared \
              --enable-gpl \
              --enable-nonfree \
              --enable-libx264 \
              --enable-libx265 \
              --enable-libvpx \
              --enable-libmp3lame \
              --enable-libopus \
              --enable-libtheora \
              --enable-libvorbis \
              --enable-libass \
              --enable-libfreetype \
              --enable-libfribidi \
              --enable-libxvid \
              --enable-libaom \
              --enable-libdav1d \
              --disable-debug \
              --disable-doc \
              --enable-optimizations \
              --enable-pic \
              --enable-version3
            make -j$(nproc)
            make install
            # å¤åˆ¶4.4ç‰ˆæœ¬çš„åº“åˆ°ä¸»ç›®å½•
            cp $INSTALL_ROOT/temp_44/lib/libavformat.so* $INSTALL_ROOT/lib/ 2>/dev/null || true
            cp $INSTALL_ROOT/temp_44/lib/libavcodec.so* $INSTALL_ROOT/lib/ 2>/dev/null || true
            cp $INSTALL_ROOT/temp_44/lib/libavutil.so* $INSTALL_ROOT/lib/ 2>/dev/null || true
          fi
          
          # è¿”å›åˆ°ä¸»åˆ†æ”¯è·å–æ­£ç¡®ç‰ˆæœ¬ä¿¡æ¯
          git checkout master 2>/dev/null || git checkout n6.0 2>/dev/null || git checkout n5.1 2>/dev/null || echo "ä½¿ç”¨å½“å‰åˆ†æ”¯"
          
          # ç¡®ä¿æ‰€æœ‰éœ€è¦çš„åº“ç‰ˆæœ¬ç¬¦å·é“¾æ¥éƒ½å­˜åœ¨
          cd $INSTALL_ROOT/lib
          echo "åˆ›å»ºåº“ç‰ˆæœ¬ç¬¦å·é“¾æ¥..."
          
          # æ£€æŸ¥å¹¶ç”Ÿæˆlibavformat.so.62, libavformat.so.60
          for file in libavformat.so.*; do
            if [[ $file =~ ^libavformat\.so\.([0-9]+)$ ]]; then
              version=${BASH_REMATCH[1]}
              if [ "$version" -ge 60 ]; then
                ln -sf $file libavformat.so.62 2>/dev/null || true
                ln -sf $file libavformat.so.60 2>/dev/null || true
              fi
              break
            fi
          done
          
          # æ£€æŸ¥å¹¶ç”Ÿæˆlibavutil.so.60, libavutil.so.58
          for file in libavutil.so.*; do
            if [[ $file =~ ^libavutil\.so\.([0-9]+)$ ]]; then
              version=${BASH_REMATCH[1]}
              if [ "$version" -ge 58 ]; then
                ln -sf $file libavutil.so.60 2>/dev/null || true
                ln -sf $file libavutil.so.58 2>/dev/null || true
              fi
              break
            fi
          done
          
          # æ£€æŸ¥å¹¶ç”Ÿæˆlibavcodec.so.62, libavcodec.so.60
          for file in libavcodec.so.*; do
            if [[ $file =~ ^libavcodec\.so\.([0-9]+)$ ]]; then
              version=${BASH_REMATCH[1]}
              if [ "$version" -ge 60 ]; then
                ln -sf $file libavcodec.so.62 2>/dev/null || true
                ln -sf $file libavcodec.so.60 2>/dev/null || true
              fi
              break
            fi
          done
          
          # æ˜¾ç¤ºç”Ÿæˆçš„åº“æ–‡ä»¶
          echo "ç”Ÿæˆçš„åº“æ–‡ä»¶:"
          ls -la libavformat.so* libavcodec.so* libavutil.so* 2>/dev/null || echo "æœªæ‰¾åˆ°é¢„æœŸçš„åº“æ–‡ä»¶"

      # ğŸ§© ä¿®è¡¥ ELF è§£é‡Šå™¨
      - name: ä¿®è¡¥ ELF å¯æ‰§è¡Œæ–‡ä»¶
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          INTERP=$INSTALL_ROOT/lib/ld-linux-aarch64.so.1
          echo "ğŸ”§ ä¿®è¡¥ ELF è§£é‡Šå™¨: $INTERP"
          for DIR in bin; do
            if [ -d "$INSTALL_ROOT/$DIR" ]; then
              echo "ğŸ“ ä¿®è¡¥ $DIR ..."
              find "$INSTALL_ROOT/$DIR" -type f -exec file {} \; | grep ELF | cut -d: -f1 | while read f; do
                patchelf --set-interpreter "$f" "$INTERP" 2>/dev/null || true
              done
            fi
          done
          # ä¿®è¡¥åº“æ–‡ä»¶
          if [ -d "$INSTALL_ROOT/lib" ]; then
            echo "ğŸ“ ä¿®è¡¥ lib ..."
            find "$INSTALL_ROOT/lib" -type f -exec file {} \; | grep ELF | cut -d: -f1 | while read f; do
                patchelf --set-interpreter "$f" "$INTERP" 2>/dev/null || true
            done
          fi

      # ğŸ§± æ‰“åŒ…æ„å»ºç»“æœ
      - name: æ‰“åŒ… glibc ç›®å½•
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          cd /data/data/com.termux/files/usr
          TAR_NAME="termux-glibc-ffmpeg-${VERSION}.tar.gz"
          tar -czvf /home/runner/$TAR_NAME glibc
          echo "$LATEST_COMMIT" > ${{ env.LAST_COMMIT_FILE }}
          echo "TAR_NAME=$TAR_NAME" >> $GITHUB_ENV

      # â¬†ï¸ ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        if: steps.check_build.outputs.skip_build == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TAR_NAME }}
          path: /home/runner/${{ env.TAR_NAME }}

